---
- name: Ultra Final Professional Dashboard
  hosts: localhost
  gather_facts: yes

  tasks:

    - name: Ensure reports folder exists
      file:
        path: reports
        state: directory

    # CPU
    - name: Get CPU usage
      shell: "top -bn1 | grep 'Cpu(s)' | awk '{print 100 - $8}'"
      register: cpu_usage_raw

    - set_fact:
        cpu_usage: "{{ cpu_usage_raw.stdout | float | round(0) | int }}"

    # RAM
    - set_fact:
        ram_usage: "{{ ((ansible_facts.memtotal_mb - ansible_facts.memfree_mb) * 100 / ansible_facts.memtotal_mb) | float | round(0) | int }}"

    # DISK
    - name: Get disk usage
      shell: "df -h / | awk 'NR==2 {print $5}' | sed 's/%//' "
      register: disk_usage_raw

    - set_fact:
        disk_usage: "{{ disk_usage_raw.stdout | int }}"

    # TOP PROCESSES
    - name: Get top 5 CPU processes
      shell: "ps -eo pid,cmd,%cpu --sort=-%cpu | head -6"
      register: top_cpu

    - name: Get top 5 RAM processes
      shell: "ps -eo pid,cmd,%mem --sort=-%mem | head -6"
      register: top_ram

    # SYSTEM INFO
    - set_fact:
        hostname: "{{ ansible_facts.hostname }}"
        os: "{{ ansible_facts.distribution }} {{ ansible_facts.distribution_version }}"
        kernel: "{{ ansible_facts.kernel }}"
        cpu_model: "{{ ansible_facts.processor[2] }}"
        cpu_cores: "{{ ansible_facts.processor_vcpus }}"
        total_ram: "{{ ansible_facts.memtotal_mb | int }}"

    # FINAL DASHBOARD
    - name: Create next-level dashboard
      copy:
        dest: reports/dashboard_advanced.html
        content: |
          <!DOCTYPE html>
          <html>
          <head>
            <title>Next-Level Monitoring Dashboard</title>
            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

            <style>
              body {
                background: #0d1117;
                color: white;
                font-family: Arial;
                margin: 0;
                padding: 20px;
              }

              .title {
                text-align: center;
                font-size: 55px;
                color: #4ea1ff;
                margin-bottom: 20px;
              }

              .grid {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 20px;
              }

              .card {
                background: linear-gradient(135deg, #161b22, #1f2937);
                padding: 20px;
                border-radius: 15px;
                box-shadow: 0px 0px 12px black;
                transition: transform 0.2s;
              }

              .card:hover {
                transform: scale(1.05);
              }

              table {
                width: 100%;
                margin-top: 10px;
              }

              table, th, td {
                border: 1px solid #30363d;
                border-collapse: collapse;
              }

              th, td {
                padding: 8px;
              }

              .info {
                margin: 30px 0;
                padding: 20px;
                border-radius: 15px;
                background: #161b22;
              }

              .auto-refresh {
                text-align: center;
                margin-top: 15px;
                color: #91ff91;
                font-size: 18px;
              }
            </style>
          </head>

          <body>

            <h1 class="title">ðŸš€ Ultimate System Monitoring Dashboard</h1>

            <div class="auto-refresh">Auto Refresh Every 5 Seconds</div>

            <div class="grid">
              <div class="card">
                <h2>CPU Usage</h2>
                <canvas id="cpuGauge"></canvas>
              </div>

              <div class="card">
                <h2>RAM Usage</h2>
                <canvas id="ramGauge"></canvas>
              </div>

              <div class="card">
                <h2>Disk Usage</h2>
                <canvas id="diskGauge"></canvas>
              </div>
            </div>

            <div class="info">
              <h2>System Information</h2>
              <p><b>Hostname:</b> {{ hostname }}</p>
              <p><b>OS:</b> {{ os }}</p>
              <p><b>Kernel:</b> {{ kernel }}</p>
              <p><b>CPU Model:</b> {{ cpu_model }}</p>
              <p><b>CPU Cores:</b> {{ cpu_cores }}</p>
              <p><b>Total RAM:</b> {{ total_ram }} MB</p>
            </div>

            <div class="grid">
              <div class="card">
                <h2>Top CPU Processes</h2>
                <pre>{{ top_cpu.stdout }}</pre>
              </div>

              <div class="card">
                <h2>Top RAM Processes</h2>
                <pre>{{ top_ram.stdout }}</pre>
              </div>

              <div class="card">
                <h2>Status Summary</h2>
                <p>CPU: {{ cpu_usage }}%</p>
                <p>RAM: {{ ram_usage }}%</p>
                <p>Disk: {{ disk_usage }}%</p>
              </div>
            </div>

            <script>
              function gauge(id, value, color) {
                new Chart(document.getElementById(id), {
                  type: "doughnut",
                  data: {
                    labels: ["Used", "Free"],
                    datasets: [{
                      data: [value, 100-value],
                      backgroundColor: [color, "#30363d"],
                      borderWidth: 0
                    }]
                  },
                  options: { cutout: "70%" }
                });
              }

              gauge("cpuGauge", {{ cpu_usage }}, "#2ecc71");
              gauge("ramGauge", {{ ram_usage }}, "#f1c40f");
              gauge("diskGauge", {{ disk_usage }}, "#e74c3c");

              setTimeout(() => location.reload(), 5000);
            </script>

          </body>
          </html>
