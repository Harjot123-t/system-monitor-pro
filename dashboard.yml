---
- name: Professional System Monitoring Suite
  hosts: localhost
  gather_facts: yes

  vars:
    cpu_threshold: 80
    ram_threshold: 80
    disk_threshold: 80

    telegram_bot_token: "YOUR_BOT_TOKEN"
    telegram_chat_id: "YOUR_CHAT_ID"

    txt_report_file: "reports/system_report.txt"
    html_report_file: "reports/system_report.html"
    metrics_file: "reports/metrics.json"
    dashboard_file: "reports/dashboard_advanced.html"

  tasks:

    # ---------------------------
    # CREATE REPORTS DIRECTORY
    # ---------------------------
    - name: Ensure reports directory exists
      file:
        path: reports
        state: directory
        mode: '0755'

    # ---------------------------
    # CPU USAGE
    # ---------------------------
    - name: Get CPU usage
      shell: "top -bn1 | grep 'Cpu(s)' | awk '{print $2 + $4}'"
      register: cpu_usage_raw

    - name: Convert CPU usage
      set_fact:
        cpu_usage: "{{ cpu_usage_raw.stdout | float | round(0) | int }}"

    # ---------------------------
    # RAM USAGE
    # ---------------------------
    - name: Calculate RAM usage
      set_fact:
        ram_usage_percent: "{{ ((ansible_facts.memtotal_mb - ansible_facts.memfree_mb) / ansible_facts.memtotal_mb * 100) | float | round(0) | int }}"

    # ---------------------------
    # DISK USAGE
    # ---------------------------
    - name: Get disk usage
      shell: "df -h / | awk 'NR==2 {print $5}' | sed 's/%//'"
      register: disk_usage_raw

    - name: Convert disk usage
      set_fact:
        disk_usage: "{{ disk_usage_raw.stdout | int }}"

    # ---------------------------
    # SERVICES (WSL SAFE)
    # ---------------------------
    - name: Check SSH running
      shell: "pgrep ssh || true"
      register: ssh_status

    - name: Check cron running
      shell: "pgrep cron || pgrep crond || true"
      register: cron_status

    # ---------------------------
    # SAVE METRICS TO JSON
    # ---------------------------
    - name: Save metrics to JSON
      copy:
        dest: "{{ metrics_file }}"
        content: |
          {
            "cpu_usage": {{ cpu_usage }},
            "ram_usage_percent": {{ ram_usage_percent }},
            "disk_usage": {{ disk_usage }},
            "ssh_running": "{{ 'YES' if ssh_status.stdout != '' else 'NO' }}",
            "cron_running": "{{ 'YES' if cron_status.stdout != '' else 'NO' }}"
          }

    # ---------------------------
    # TXT REPORT
    # ---------------------------
    - name: Create system report (TXT)
      copy:
        dest: "{{ txt_report_file }}"
        content: |
          ===== SYSTEM REPORT =====

          CPU:  {{ cpu_usage }}%
          RAM:  {{ ram_usage_percent }}%
          DISK: {{ disk_usage }}%

          SSH running: {{ 'YES' if ssh_status.stdout != '' else 'NO' }}
          Cron running: {{ 'YES' if cron_status.stdout != '' else 'NO' }}

          ==========================

    # ---------------------------
    # HTML REPORT
    # ---------------------------
    - name: Create HTML report
      copy:
        dest: "{{ html_report_file }}"
        content: |
          <html>
          <head>
            <title>System Monitoring</title>
          </head>
          <body>
            <h1>System Monitoring Dashboard</h1>

            <h2>CPU: {{ cpu_usage }}%</h2>
            <h2>RAM: {{ ram_usage_percent }}%</h2>
            <h2>Disk: {{ disk_usage }}%</h2>

            <h3>SSH Running: {{ 'YES' if ssh_status.stdout != '' else 'NO' }}</h3>
            <h3>Cron Running: {{ 'YES' if cron_status.stdout != '' else 'NO' }}</h3>
          </body>
          </html>

    # ---------------------------
    # TELEGRAM ALERT
    # ---------------------------
    - name: Telegram alert if thresholds exceeded
      uri:
        url: "https://api.telegram.org/bot{{ telegram_bot_token }}/sendMessage"
        method: POST
        body_format: json
        body:
          chat_id: "{{ telegram_chat_id }}"
          text: |
            ðŸš¨ SYSTEM ALERT ðŸš¨
            CPU:  {{ cpu_usage }}%
            RAM:  {{ ram_usage_percent }}%
            DISK: {{ disk_usage }}%
        status_code: 200
      when:
        - cpu_usage > cpu_threshold
        - ram_usage_percent > ram_threshold
        - disk_usage > disk_threshold

    # ---------------------------
    # ADVANCED DASHBOARD
    # ---------------------------
    - name: Generate fancy HTML dashboard
      copy:
        dest: "{{ dashboard_file }}"
        content: |
          <!DOCTYPE html>
          <html>
          <head>
            <title>System Monitoring Dashboard</title>
            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <style>
              body { font-family: Arial; background:#f4f4f9; margin:20px; }
              .card { background:white; padding:20px; border-radius:12px; margin-bottom:20px; box-shadow:0 0 10px rgba(0,0,0,0.1);}
              h1, h2 { text-align:center; }
              pre { background:#eee; padding:10px; border-radius:8px; }
            </style>
          </head>
          <body>
            <h1>ðŸ“Š Advanced System Monitoring Dashboard</h1>

            <div class="card">
              <h2>CPU / RAM / Disk Usage</h2>
              <canvas id="systemChart"></canvas>
            </div>

            <div class="card">
              <h2>Services</h2>
              <p><b>SSH:</b> {{ 'YES' if ssh_status.stdout != '' else 'NO' }}</p>
              <p><b>Cron:</b> {{ 'YES' if cron_status.stdout != '' else 'NO' }}</p>
            </div>

            <script>
              const ctx = document.getElementById('systemChart').getContext('2d');
              new Chart(ctx, {
                type: 'bar',
                data: {
                  labels: ['CPU (%)', 'RAM (%)', 'Disk (%)'],
                  datasets: [{
                    label: 'Usage',
                    data: [
                      {{ cpu_usage }},
                      {{ ram_usage_percent }},
                      {{ disk_usage }}
                    ],
                    backgroundColor: ['rgba(255,99,132,0.6)', 'rgba(54,162,235,0.6)', 'rgba(255,206,86,0.6)'],
                    borderColor: ['rgba(255,99,132,1)', 'rgba(54,162,235,1)', 'rgba(255,206,86,1)'],
                    borderWidth: 1
                  }]
                },
                options: {
                  scales: { y: { beginAtZero:true, max:100 } }
                }
              });
            </script>
          </body>
          </html>

    - name: Print dashboard path
      debug:
        msg: "Fancy dashboard generated â†’ {{ dashboard_file }}"
